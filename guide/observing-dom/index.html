<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="google-site-verification" content="OKMYmcVuMfm9H_UjfNXPzRb2c0QoBtmZ7v1KwHNXnRQ"><link rel="icon" type="image/png" href="/_astro/vm.C4h557K-.png"><meta name="generator" content="Astro v5.1.5"><title>Observing DOM - Violentmonkey</title><script type="text/partytown" async src="https://www.googletagmanager.com/gtag/js?id=G-2E0X3LSCBM"></script> <script type="text/partytown">
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag('js', new Date());

  gtag('config', 'G-2E0X3LSCBM');
</script><link rel="stylesheet" href="/_astro/_path_.BBgV8g_f.css">
<style>aside[data-astro-cid-ssfzsv2f]{position:fixed;top:var(--nav-height);left:0;bottom:0;z-index:20;width:var(--aside-width);--un-translate-x:-100%;transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z));border-right-width:1px;--un-border-opacity:1;border-color:rgb(229 231 235 / var(--un-border-opacity));--un-bg-opacity:1;background-color:rgb(255 255 255 / var(--un-bg-opacity));transition-property:transform;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}aside[data-astro-cid-ssfzsv2f] a[data-astro-cid-ssfzsv2f]:not(.active):not(:hover){--un-text-opacity:1;color:rgb(107 114 128 / var(--un-text-opacity))}@media (min-width: 1024px){aside[data-astro-cid-ssfzsv2f]{position:sticky;grid-row-start:1;grid-row-end:3;max-height:calc(100vh - var(--nav-height));--un-translate-x:0;transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z));border-style:none;transition:none}}aside[data-astro-cid-ssfzsv2f]:target{--un-translate-x:0;--un-translate-y:0;transform:translate(var(--un-translate-x)) translateY(var(--un-translate-y)) translateZ(var(--un-translate-z)) rotate(var(--un-rotate)) rotateX(var(--un-rotate-x)) rotateY(var(--un-rotate-y)) rotate(var(--un-rotate-z)) skew(var(--un-skew-x)) skewY(var(--un-skew-y)) scaleX(var(--un-scale-x)) scaleY(var(--un-scale-y)) scaleZ(var(--un-scale-z))}aside[data-astro-cid-ssfzsv2f] .backdrop[data-astro-cid-ssfzsv2f]{display:none;font-size:0}aside[data-astro-cid-ssfzsv2f]:target .backdrop[data-astro-cid-ssfzsv2f]{position:absolute;top:0;bottom:0;left:100%;display:block;width:100vw;background-color:#a1a1aacc}@media (min-width: 1024px){aside[data-astro-cid-ssfzsv2f]:target .backdrop[data-astro-cid-ssfzsv2f]{display:none}}
</style><script>!(function(w,p,f,c){if(!window.crossOriginIsolated && !navigator.serviceWorker) return;c=w[p]=Object.assign(w[p]||{},{"lib":"/~partytown/","debug":false});c[f]=(c[f]||[]).concat(["dataLayer.push"])})(window,'partytown','forward');/* Partytown 0.11.0 - MIT QwikDev */
const t={preserveBehavior:!1},e=e=>{if("string"==typeof e)return[e,t];const[n,r=t]=e;return[n,{...t,...r}]},n=Object.freeze((t=>{const e=new Set;let n=[];do{Object.getOwnPropertyNames(n).forEach((t=>{"function"==typeof n[t]&&e.add(t)}))}while((n=Object.getPrototypeOf(n))!==Object.prototype);return Array.from(e)})());!function(t,r,o,i,a,s,c,l,d,p,u=t,f){function h(){f||(f=1,"/"==(c=(s.lib||"/~partytown/")+(s.debug?"debug/":""))[0]&&(d=r.querySelectorAll('script[type="text/partytown"]'),i!=t?i.dispatchEvent(new CustomEvent("pt1",{detail:t})):(l=setTimeout(v,(null==s?void 0:s.fallbackTimeout)||1e4),r.addEventListener("pt0",w),a?y(1):o.serviceWorker?o.serviceWorker.register(c+(s.swPath||"partytown-sw.js"),{scope:c}).then((function(t){t.active?y():t.installing&&t.installing.addEventListener("statechange",(function(t){"activated"==t.target.state&&y()}))}),console.error):v())))}function y(e){p=r.createElement(e?"script":"iframe"),t._pttab=Date.now(),e||(p.style.display="block",p.style.width="0",p.style.height="0",p.style.border="0",p.style.visibility="hidden",p.setAttribute("aria-hidden",!0)),p.src=c+"partytown-"+(e?"atomics.js?v=0.11.0":"sandbox-sw.html?"+t._pttab),r.querySelector(s.sandboxParent||"body").appendChild(p)}function v(n,o){for(w(),i==t&&(s.forward||[]).map((function(n){const[r]=e(n);delete t[r.split(".")[0]]})),n=0;n<d.length;n++)(o=r.createElement("script")).innerHTML=d[n].innerHTML,o.nonce=s.nonce,r.head.appendChild(o);p&&p.parentNode.removeChild(p)}function w(){clearTimeout(l)}s=t.partytown||{},i==t&&(s.forward||[]).map((function(r){const[o,{preserveBehavior:i}]=e(r);u=t,o.split(".").map((function(e,r,o){var a;u=u[o[r]]=r+1<o.length?u[o[r]]||(a=o[r+1],n.includes(a)?[]:{}):(()=>{let e=null;if(i){const{methodOrProperty:n,thisObject:r}=((t,e)=>{let n=t;for(let t=0;t<e.length-1;t+=1)n=n[e[t]];return{thisObject:n,methodOrProperty:e.length>0?n[e[e.length-1]]:void 0}})(t,o);"function"==typeof n&&(e=(...t)=>n.apply(r,...t))}return function(){let n;return e&&(n=e(arguments)),(t._ptf=t._ptf||[]).push(o,arguments),n}})()}))})),"complete"==r.readyState?h():(t.addEventListener("DOMContentLoaded",h),t.addEventListener("load",h))}(window,document,navigator,top,window.crossOriginIsolated);;(e=>{e.addEventListener("astro:before-swap",e=>{let r=document.body.querySelector("iframe[src*='/~partytown/']");if(r)e.newDocument.body.append(r)})})(document);</script></head> <body> <header class="sticky top-0 left-0 right-0 bg-white z-10"> <nav> <a href="/" class="nav-icon sm:hidden"> <svg viewBox="0 0 24 24"> <path d="M12 0l-12 12h4v12h5v-8h6v8h5v-12h4z"></path> </svg> </a> <a class="nav-icon lg:hidden" href="#violentmonkey/sidebar"> <svg viewBox="0 0 24 24"> <path d="M0 4h24v2h-24zm0 8h24v2h-24zm0 8h24v2h-24z"></path> </svg> </a> <a href="/" class="brand hidden sm:block"> Violentmonkey </a> <span class="flex-1"></span> <div class="overflow-auto min-w-0 flex whitespace-no-wrap"> <a class="nav-item " href="/get-it/"> Get it </a><a class="nav-item " href="/guide/creating-a-userscript/"> Guide </a><a class="nav-item " href="/api/gm/"> API </a><a class="nav-item " href="/faq/"> FAQ </a><a class="nav-item " href="/posts/"> Blog </a> </div> </nav> <div class="w-full h-px"> <div class="w-full h-full origin-left bg-yellow-500 scale-x-0" data-scroll-indicator></div> </div> <script type="module" src="/_astro/ScrollIndicator.astro_astro_type_script_index_0_lang.0f22gRsq.js"></script> </header> <div class="relative z-0">  <main class="has-sidebar"> <aside id="violentmonkey/sidebar" data-astro-cid-ssfzsv2f><a href="#" rel="external" class="backdrop" data-astro-cid-ssfzsv2f>
Close
</a><ul class="list-none h-full p-4 overflow-y-auto" data-astro-cid-ssfzsv2f><li data-astro-cid-ssfzsv2f><a href="/guide/creating-a-userscript/" class data-astro-cid-ssfzsv2f>Creating a userscript</a></li><li data-astro-cid-ssfzsv2f><a href="/guide/using-modern-syntax/" class data-astro-cid-ssfzsv2f>Modern Syntax</a></li><li data-astro-cid-ssfzsv2f><a href="/guide/observing-dom/" class="active" data-astro-cid-ssfzsv2f>Observing DOM</a></li><li data-astro-cid-ssfzsv2f><a href="/guide/keyboard-shortcuts/" class data-astro-cid-ssfzsv2f>Keyboard Shortcuts</a></li></ul></aside> <h1 class="grid-col-start-2 mt-0 pt-8">Observing DOM</h1> <div class="toc grid-col-start-3 grid-row-start-2"><ul><li style="--toc-depth:0"><a href="#background">Background</a></li><li style="--toc-depth:0"><a href="#introducing-violentmonkeydom">Introducing @violentmonkey/dom</a></li><li style="--toc-depth:0"><a href="#requirements">Requirements</a></li><li style="--toc-depth:0"><a href="#observing">Observing</a></li><li style="--toc-depth:0"><a href="#optionally-using-jquery">(Optionally) Using jQuery</a></li></ul><hr class="lg:hidden"></div><script type="module" src="/_astro/ToC.astro_astro_type_script_index_0_lang.Cc0lKERm.js"></script> <section class="grid-col-start-2"> <article class="flex-1 min-w-0">  <h2 id="background">Background</h2>
<p>It is a common case to operate on elements that are created dynamically, which may not be ready even on <code>document-end</code>.</p>
<p>In earlier userscripts we can see authors using timers to detect DOM elements periodically, which works in most browsers but is less effective, and there is likely obvious lag after the elements appear and before the operations are performed.</p>
<p>A better way to do stuff when certain element is ready is to use <a href="https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver">MutationObserver</a> instead of timers. <code>MutationObserver</code> is well supported in modern browsers, including those Violentmonkey works on, as defined <a href="https://github.com/violentmonkey/violentmonkey/blob/master/.browserslistrc">here</a>.</p>
<p>You can stop reading this now if you are familiar with <code>MutationObserver</code> and prefer native APIs.</p>
<h2 id="introducing-violentmonkeydom">Introducing @violentmonkey/dom</h2>
<p>If you are looking for an easy and friendly way to observe elements, <a href="https://github.com/violentmonkey/vm-dom">@violentmonkey/dom</a> might be what you want.</p>
<infobox>
  [@violentmonkey/dom][vm-dom] is a library provided by the Violentmonkey team. Nevertheless, it is just pure JavaScript and can be used with other script managers.
</infobox>
<p>Once the library is required, we can use its methods under the <code>VM</code> namespace. See <a href="https://www.jsdocs.io/package/@violentmonkey/dom">the documentation</a> for more details.</p>
<h2 id="requirements">Requirements</h2>
<p>Add <code>@violentmonkey/dom</code> to the <a href="/api/metadata-block/">meta block</a> of your script:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display: grid;"><span data-line=""><span style="color:#6A737D">// ==UserScript==</span></span>
<span data-line=""><span style="color:#6A737D">// ...</span></span>
<span class="highlighted" data-line="" data-highlighted-line=""><span style="color:#6A737D">// @require https://cdn.jsdelivr.net/npm/@violentmonkey/dom@2</span></span>
<span data-line=""><span style="color:#6A737D">// ==/UserScript==</span></span></code></pre></figure>
<p>If the project is initiated from <a href="https://github.com/violentmonkey/generator-userscript">our generator</a>, it’s likely that the dependency is already included.</p>
<h2 id="observing">Observing</h2>
<p>After preparing the requirements, we can observe elements by <code>VM.observe</code> (<a href="https://www.jsdocs.io/package/@violentmonkey/dom#observe">doc</a>), which utilizes <code>MutationObserver</code> under the hood.</p>
<p>For example, prepend <code>&#x3C;h1>Profile&#x3C;/h1></code> to the dynamically created <code>&#x3C;div class="profile"></code>:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display: grid;"><span data-line=""><span style="color:#D73A49">const</span><span style="color:#005CC5"> disconnect</span><span style="color:#D73A49"> =</span><span style="color:#005CC5"> VM</span><span style="color:#24292E">.</span><span style="color:#6F42C1">observe</span><span style="color:#24292E">(document.body, () </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">  // Find the target node</span></span>
<span data-line=""><span style="color:#D73A49">  const</span><span style="color:#005CC5"> node</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> document.</span><span style="color:#6F42C1">querySelector</span><span style="color:#24292E">(</span><span style="color:#032F62">'.profile'</span><span style="color:#24292E">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> (node) {</span></span>
<span data-line=""><span style="color:#D73A49">    const</span><span style="color:#005CC5"> h1</span><span style="color:#D73A49"> =</span><span style="color:#24292E"> document.</span><span style="color:#6F42C1">createElement</span><span style="color:#24292E">(</span><span style="color:#032F62">'h1'</span><span style="color:#24292E">);</span></span>
<span data-line=""><span style="color:#24292E">    h1.textContent </span><span style="color:#D73A49">=</span><span style="color:#032F62"> 'Profile'</span><span style="color:#24292E">;</span></span>
<span data-line=""><span style="color:#24292E">    node.</span><span style="color:#6F42C1">prepend</span><span style="color:#24292E">(h1);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // disconnect observer</span></span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#005CC5"> true</span><span style="color:#24292E">;</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""><span style="color:#24292E">});</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">// You can also disconnect the observer explicitly when it's not used any more</span></span>
<span data-line=""><span style="color:#6F42C1">disconnect</span><span style="color:#24292E">();</span></span></code></pre></figure>
<p>Note that <code>return true</code> in the end is needed to disconnect the observer once we find the target node. Otherwise the detection continues and makes useless callbacks.</p>
<p>To observe <code>document.body</code> we must make sure <code>document.body</code> exists. This should not be a problem if <code>@run-at</code> is omitted or set to a value other than <code>document-start</code>.</p>
<h2 id="optionally-using-jquery">(Optionally) Using jQuery</h2>
<p>This is not recommended though, we put it here just in case some people are big fans of jQuery.</p>
<p>It is quite simple to integrate jQuery with the observer. Before we begin we must include jQuery as a dependency:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display: grid;"><span data-line=""><span style="color:#6A737D">// ==UserScript==</span></span>
<span data-line=""><span style="color:#6A737D">// ...</span></span>
<span data-line=""><span style="color:#6A737D">// @require https://cdn.jsdelivr.net/npm/@violentmonkey/dom@1</span></span>
<span class="highlighted" data-line="" data-highlighted-line=""><span style="color:#6A737D">// @require https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js</span></span>
<span data-line=""><span style="color:#6A737D">// ==/UserScript==</span></span></code></pre></figure>
<p>Then we can wrap the node with jQuery and operate it the jQuery way:</p>
<figure data-rehype-pretty-code-figure=""><pre style="background-color:#fff;color:#24292e" tabindex="0" data-language="js" data-theme="github-light"><code data-language="js" data-theme="github-light" style="display: grid;"><span data-line=""><span style="color:#005CC5">VM</span><span style="color:#24292E">.</span><span style="color:#6F42C1">observe</span><span style="color:#24292E">(document.body, () </span><span style="color:#D73A49">=></span><span style="color:#24292E"> {</span></span>
<span data-line=""><span style="color:#6A737D">  // Find the target node</span></span>
<span data-line=""><span style="color:#D73A49">  const</span><span style="color:#005CC5"> $node</span><span style="color:#D73A49"> =</span><span style="color:#6F42C1"> $</span><span style="color:#24292E">(</span><span style="color:#032F62">'.profile'</span><span style="color:#24292E">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#D73A49">  if</span><span style="color:#24292E"> ($node.</span><span style="color:#005CC5">length</span><span style="color:#24292E">) {</span></span>
<span data-line=""><span style="color:#24292E">    $node.</span><span style="color:#6F42C1">prepend</span><span style="color:#24292E">(</span><span style="color:#032F62">'&#x3C;h1>Profile&#x3C;/h1>'</span><span style="color:#24292E">);</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#6A737D">    // disconnect observer</span></span>
<span data-line=""><span style="color:#D73A49">    return</span><span style="color:#005CC5"> true</span><span style="color:#24292E">;</span></span>
<span data-line=""><span style="color:#24292E">  }</span></span>
<span data-line=""><span style="color:#24292E">});</span></span></code></pre></figure>  </article> </section> <section class="grid-col-start-2"> <hr>  </section> </main>  </div> <footer class="flex p-6 pb-16 border-t border-gray-400 lg:pb-6"> <div>Violentmonkey © All rights reserved.</div> <a class="mx-2" href="/privacy/"> Privacy Policy </a> </footer> <div data-discord data-astro-cid-mahorubk> <div class="discord-panel" data-astro-cid-mahorubk> <div class="p-2 cursor-pointer" data-discord-toggle data-astro-cid-mahorubk> <svg viewBox="0 0 12 12" class="w-4 h-4" data-astro-cid-mahorubk> <path d="M0 1L11 12L12 11L1 0zM11 0L0 11L1 12L12 1z" stroke="none" fill="currentColor" data-astro-cid-mahorubk></path> </svg> </div> <iframe class="w-full h-full bg-blue-100 rounded" data-src="https://discord.com/widget?id=995346102003965952&theme=dark" sandbox="allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts" data-astro-cid-mahorubk></iframe> </div> <button class="discord-button" data-discord-toggle data-astro-cid-mahorubk> Open Chat </button> </div> <script type="module">const e=document.querySelector("[data-discord]");e&&e.addEventListener("click",r=>{if(!r.target.closest("[data-discord-toggle]"))return;e.classList.toggle("discord-open");const t=e.querySelector("iframe[data-src]");t&&!t.src&&t.dataset.src&&(t.src=t.dataset.src)});</script>  </body></html>